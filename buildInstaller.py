#!/usr/bin/python
__copyright__ =  """
Copyright (c) 2008, David Brezina. All rights reserved.
Redistribution and use of the script is limited by the BSD licence (http://creativecommons.org/licenses/BSD/).
"""

__version__ = "0.9"

__doc__ = """
buildInstaller: build FLW installer from contents described in YAML configuration file.
Documentation: http://wiki.davi.cz/scripts:buildinstaller
Usage: [python] buildInstaller.py <path to contents YAML file> <installer name>
"""

import sys, os, binascii
import yaml


#################### Functions ####################

# Separator used for normalized paths
SEP = "/"

def normalizePath(*paths):
	"""
	Convert path to correct independent form.
	"""
	
	return SEP.join(map(lambda x: SEP.join(x.split(os.sep)), paths))


#################### Building the FLW installer ####################

# get the command-line parameters
if len(sys.argv)<3:
	print __doc__
else:
	# 1. load YAML contents file
	contentsFile = file(sys.argv[1])
	contents = yaml.load(contentsFile.read())
	contentsFilePath = os.path.dirname(sys.argv[1])
	bundles = contents["bundles"]
	
	# 2. load files & build the installer
	if(sys.argv[2][-4:] != ".flw"):
		installerName = sys.argv[2] + ".flw"
	else:
		installerName = sys.argv[2]
	installer = open(installerName, "w")
	installer.write('"""\nFLW installer built with the buildInstaller.py script by David Brezina (davi.cz), 2008\n"""\n\n')
	
	# initialization in the installer
	installer.write("NAME = '%s'\n" % contents["name"])
	installer.write("LICENCE = %s\n\n" % repr(contents["licence"]))
	installer.write("files = {}\n")
	installer.write("folders = {}\n")
	for bundleName in bundles:
		# files dict is indexed by (bundleName, "macros", "site-packages") tuple and target path of the file
		installer.write("files['%s', 'macros'] = {}\n" % bundleName)
		installer.write("files['%s', 'site-packages'] = {}\n" % bundleName)
		installer.write("folders['%s', 'modules-paths'] = {}\n" % bundleName)
		installer.write("folders['%s', 'site-packages-paths'] = {}\n" % bundleName)
		# macros
		if "macros" in bundles[bundleName]:
			for path, targetFolder in bundles[bundleName]["macros"].items():
				fl = open(os.path.abspath(os.path.join(contentsFilePath, path)), "r")
				targetPath = normalizePath(targetFolder, os.path.basename(path))
				installer.write("files['%s', '%s']['%s'] = '%s'\n" % (bundleName, "macros", targetPath, binascii.hexlify(fl.read())))
				fl.close()
		# modules - this needs to be separate from macros as modules' path are added to the Python environment
		if "modules" in bundles[bundleName]:
			for path, targetFolder in bundles[bundleName]["modules"].items():
				fl = open(os.path.abspath(os.path.join(contentsFilePath, path)), "r")
				targetPath = normalizePath("System", "Modules", targetFolder, os.path.basename(path))
				installer.write("files['%s', '%s']['%s'] = '%s'\n" % (bundleName, "macros", targetPath, binascii.hexlify(fl.read())))
				fl.close()
		# modules-folders
		if "modules-paths" in bundles[bundleName]:
			for folderName, path in bundles[bundleName]["modules-paths"].items():
				targetPath = normalizePath("System", "Modules", path)
				# it is intentionally indexed by path to avoid duplicated paths
				installer.write("folders['%s', '%s']['%s'] = '%s'\n" % (bundleName, "modules-paths", targetPath, folderName))
		# site-packages
		if "site-packages" in bundles[bundleName]:
			for path, targetFolder in bundles[bundleName]["site-packages"].items():
				fl = open(os.path.abspath(os.path.join(contentsFilePath, path)), "r")
				targetPath = normalizePath(targetFolder, os.path.basename(path))
				installer.write("files['%s', '%s']['%s'] = '%s'\n" % (bundleName, "site-packages", targetPath, binascii.hexlify(fl.read())))
				fl.close()
		# site-packages-folders
		if "site-packages-paths" in bundles[bundleName]:
			for folderName, path in bundles[bundleName]["site-packages-paths"].items():
				targetPath = normalizePath(path)
				# it is intentionally indexed by path to avoid duplicated paths
				installer.write("folders['%s', '%s']['%s'] = '%s'\n" % (bundleName, "site-packages-paths", targetPath, folderName))
	
	# append the installer template & close
	installer.write("\n\n" + binascii.unhexlify('696d706f7274206f732c2062696e61736369690a66726f6d20646973747574696c732e737973636f6e66696720696d706f7274206765745f707974686f6e5f6c69620a66726f6d20464c20696d706f7274202a0a0a0a0a23232323232323232323232323232323232323232046756e6374696f6e73202620636c61737365732023232323232323232323232323232323232323230a0a2320536570617261746f72207573656420666f72206e6f726d616c697a65642070617468730a534550203d20222f220a0a6465662064656e6f726d616c697a6550617468282a7061746873293a0a092222220a09436f6e76657274207061746820746f20636f7272656374204f532d646570656e64656e7420666f726d2e0a092222220a090a0972657475726e206f732e7365702e6a6f696e286d6170286c616d62646120783a206f732e7365702e6a6f696e28782e73706c69742853455029292c20706174687329290a0a64656620696e7374616c6c507974686f6e506174682866696c654e616d652c2070617468293a0a092320496e7374616c6c20666f6c64657220746f20707974686f6e206d6f64756c65732e0a090a09736974655061636b446972203d206765745f707974686f6e5f6c696228290a0966696c654e616d65203d206f732e706174682e6a6f696e28736974655061636b4469722c2066696c654e616d65202b20222e70746822290a0966203d206f70656e2866696c654e616d652c20227722290a09662e77726974652870617468290a09662e636c6f736528290a0972657475726e2066696c654e616d650a0a64656620696e7374616c6c46696c65732862617365466f6c6465722c2066696c6573293a0a09666f72207061746820696e2066696c65733a0a090974617267657450617468203d206f732e706174682e6a6f696e2862617365466f6c6465722c2064656e6f726d616c697a6550617468287061746829290a09096966206e6f74206f732e706174682e657869737473286f732e706174682e6469726e616d65287461726765745061746829293a0a0909096f732e6d616b6564697273286f732e706174682e6469726e616d65287461726765745061746829290a090966203d206f70656e28746172676574506174682c20227722290a0909662e77726974652862696e61736369692e756e6865786c6966792866696c65735b706174685d29290a0909662e636c6f736528290a0a636c6173732042756e646c65734469616c6f673a0a0a096669656c6473203d207b7d0a0a2009646566205f5f696e69745f5f2873656c662c206669656c64732c207469746c65293a0a0a090973656c662e6669656c6473203d206669656c64730a0a090973656c662e64203d204469616c6f672873656c66290a090973656c662e642e73697a65203d20506f696e74283330302c206c656e286669656c6473292a32302b3830290a090973656c662e642e43656e74657228290a090973656c662e642e7469746c65203d207469746c650a090973656c662e642e416464436f6e74726f6c28434845434b424f58434f4e54524f4c2c205265637428614944454e54322c2032302c20614944454e54322c20614155544f292c20226669656c64256422202520302c205354594c455f434845434b424f582c20272027202b206669656c64735b305d5b305d290a090965786563202273656c662e6669656c642564203d2025732220252028302c206669656c64735b305d5b315d290a0909666f72206920696e2072616e6765286c656e286669656c6473292d31293a0a09090973656c662e642e416464436f6e74726f6c28434845434b424f58434f4e54524f4c2c205265637428614944454e54322c2034302b692a32302c20614944454e54322c20614155544f292c20226669656c6425642220252028692b31292c205354594c455f434845434b424f582c20272027202b206669656c64735b692b315d5b305d290a09090965786563202273656c662e6669656c642564203d202573222025202828692b31292c206669656c64735b692b315d5b315d290a0a09646566206f6e5f63616e63656c2873656c662c20636f6465293a0a090973656c662e726573756c7473203d204e6f6e650a090973656c662e6669656c6473203d204e6f6e650a0a09646566206f6e5f6f6b2873656c662c20636f6465293a0a090973656c662e726573756c7473203d205b5d0a0909666f72206920696e2072616e6765286c656e2873656c662e6669656c647329293a0a09090973656c662e642e47657456616c756528226669656c6425642220252069290a09090965786563202273656c662e726573756c74732e617070656e6428696e742873656c662e6669656c642564292922202520690a09090969202b3d20310a090973656c662e726573756c7473203d207475706c652873656c662e726573756c7473290a090972657475726e20310a0a096465662052756e2873656c66293a0a090972657475726e2073656c662e642e52756e28290a0a636c617373204c6963656e63654469616c6f673a0a09646566205f5f696e69745f5f2873656c662c206c696e65732c207469746c65293a0a090973656c662e64203d204469616c6f672873656c66290a090973656c662e642e73697a65203d20506f696e74283430302c206c656e286c696e6573292a32302b313030290a090973656c662e642e43656e74657228290a090973656c662e642e7469746c65203d207469746c650a090973656c662e642e416464436f6e74726f6c28535441544943434f4e54524f4c2c205265637428614944454e54322c2032302c20614944454e54322c20614155544f292c20276c6963656e6365272c205354594c455f4c4142454c2c206c696e65735b305d290a0909666f72206c20696e2072616e6765286c656e286c696e6573292d31293a0a09090973656c662e642e416464436f6e74726f6c28535441544943434f4e54524f4c2c205265637428614944454e54322c2034302b6c2a32302c20614944454e54322c20614155544f292c20276c6963656e6365272c205354594c455f4c4142454c2c206c696e65735b6c2b315d290a0a090973656c662e642e416464436f6e74726f6c28434845434b424f58434f4e54524f4c2c205265637428614944454e54322c2034302b6c2a32302b32302c203336302c2034302b6c2a32302b32302b3235292c20276167726565272c205354594c455f434845434b424f582c20272049206167726565207769746820746865207465726d73206f6620746865206c6963656e636527290a090973656c662e6167726565203d20300a0a09646566206f6e5f61677265652873656c662c20636f6465293a0a090973656c662e642e47657456616c75652827616772656527290a0a09646566206f6e5f6f6b2873656c662c20636f6465293a0a090972657475726e20310a0a096465662052756e2873656c66293a0a090972657475726e2073656c662e642e52756e28290a09090909090a2323232323232323232323232323232323232323204d61696e2050726f6772616d2023232323232323232323232323232323232323230a0a2320312e2067657420696e7374616c6c6174696f6e20666f6c646572730a6d6163726f73466f6c646572203d206f732e706174682e6a6f696e28666c2e75736572706174682c20224d6163726f7322290a7061636b61676573466f6c646572203d206765745f707974686f6e5f6c696228290a0a2320322e20696e7374616c6c2066696c6573202620507974686f6e20656e7669726f6e6d656e740a232032612e2062756e646c6573206469616c6f670a696e7374616c6c42756e646c65203d207b7d0a666f722062756e646c654e616d652c2066696c655479706520696e2066696c65733a0a09696e7374616c6c42756e646c655b62756e646c654e616d655d203d2046616c73650a64203d2042756e646c65734469616c6f6728696e7374616c6c42756e646c652e6974656d7328292c204e414d45202b20223a2073656c6563742062756e646c657322290a696620642e52756e282920616e6420642e726573756c74733a0a09666f72206920696e2072616e6765286c656e28696e7374616c6c42756e646c6529293a0a0909696e7374616c6c42756e646c655b696e7374616c6c42756e646c652e6974656d7328295b695d5b305d5d203d20642e726573756c74735b695d203d3d20310a096966206e6f74206f732e706174682e657869737473286d6163726f73466f6c646572293a0a09096f732e6d616b6564697273286f732e706174682e6469726e616d65286d6163726f73466f6c64657229290a09232032622e206c6963656e6365206469616c6f670a0964203d204c6963656e63654469616c6f67284c4943454e43452e73706c697428225c6e22292c204e414d45202b20223a206c6963656e636522290a096f6b203d20642e52756e28290a097768696c65206f6b203d3d203120616e6420642e6167726565203d3d20303a0a0909666c2e4d6573736167652822596f75206861766520746f206167726565207769746820746865206c6963656e636520746f2070726f636565642e22290a09096f6b203d20642e52756e28290a096966206f6b203d3d203120616e6420642e6167726565203d3d20313a0a0909232032632e20636f70792066696c65730a09097472793a0a090909666f722062756e646c654e616d652c2066696c655479706520696e2066696c65733a0a09090909696620696e7374616c6c42756e646c655b62756e646c654e616d655d3a0a090909090969662066696c6554797065203d3d20226d6163726f73223a0a090909090909696e7374616c6c46696c6573286d6163726f73466f6c6465722c2066696c65735b62756e646c654e616d652c2066696c65547970655d290a0909090909656c69662066696c6554797065203d3d2022736974652d7061636b61676573223a0a090909090909696e7374616c6c46696c6573287061636b61676573466f6c6465722c2066696c65735b62756e646c654e616d652c2066696c65547970655d290a09090909092320696e7374616c6c20706174687320746f2074686520656e7669726f6e6d656e740a0909090909666f7220706174682c20666f6c6465724e616d6520696e20666f6c646572735b62756e646c654e616d652c20226d6f64756c65732d7061746873225d2e6974656d7328293a0a090909090909696e7374616c6c507974686f6e5061746828666f6c6465724e616d652c206f732e706174682e6a6f696e286d6163726f73466f6c6465722c2064656e6f726d616c697a655061746828706174682929290a0909090909666f7220706174682c20666f6c6465724e616d6520696e20666f6c646572735b62756e646c654e616d652c2022736974652d7061636b616765732d7061746873225d2e6974656d7328293a0a090909090909696e7374616c6c507974686f6e5061746828666f6c6465724e616d652c206f732e706174682e6a6f696e287061636b61676573466f6c6465722c2064656e6f726d616c697a655061746828706174682929290a0909092320636f6e6669726d6174696f6e206469616c6f670a090909666c2e4d657373616765282242756e646c6528732920686173206265656e20696e7374616c6c65642e5c6e436c69636b205265736574204d6163726f20627574746f6e20666f72206368616e67657320746f2074616b65206566666563742e22290a09096578636570743a0a090909666c2e4d6573736167652822496e7374616c6c6174696f6e20776173206e6f74207375636365737366756c2e22290a'))
	installer.close()
